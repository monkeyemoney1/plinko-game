# Система выплат (Withdrawals System)

## Обзор

Настроена комплексная система выплат с поддержкой:
- Автоматических и ручных выплат
- Комиссий и лимитов
- Админ-панели управления
- Очереди автообработки

## Основные компоненты

### 1. Конфигурация (`src/lib/config/withdrawals.ts`)

#### Лимиты
- Минимальная сумма: 0.1 TON
- Максимальная сумма: 100 TON
- Дневной лимит: 500 TON на пользователя
- Максимум операций в день: 10

#### Комиссии
- Фиксированная: 0.01 TON
- Процентная: 2%
- Применяется максимальная из двух

#### Автообработка
- Включена для сумм до 10 TON
- Ручная проверка для сумм от 50 TON

### 2. API Эндпоинты

#### `/api/withdrawals/create` (POST)
Создание заявки на вывод с:
- Валидацией лимитов
- Расчетом комиссий
- Проверкой возраста аккаунта
- Автоматической категоризацией

#### `/api/withdrawals/process` (POST)
Обработка конкретной заявки (существующий)

#### `/api/withdrawals/status` (GET)
Статус заявок пользователя (существующий)

#### `/api/admin/withdrawals` (GET/POST)
Админ-панель управления:
- Просмотр всех заявок
- Одобрение/отклонение
- Добавление заметок
- Статистика

#### `/api/withdrawals/auto-process` (GET/POST)
Управление очередью автообработки

### 3. База данных

Обновленная таблица `withdrawals`:
```sql
- fee DECIMAL(15, 6) -- Комиссия
- net_amount DECIMAL(15, 6) -- Сумма к выводу
- auto_process BOOLEAN -- Флаг автообработки
- admin_notes TEXT -- Заметки админа
- reviewed_by INTEGER -- ID проверившего админа
- status: pending, processing, completed, failed, cancelled, manual_review
```

### 4. Пользовательский интерфейс

#### Профиль пользователя
- Калькулятор комиссий в реальном времени
- Подтверждение с детализацией
- Информирование о статусах

#### Админ-панель (`/admin/withdrawals`)
- Таблица всех заявок
- Фильтры по статусам
- Модальные окна управления
- Статистика по статусам

## Настройка и использование

### 1. Миграция базы данных
```bash
# Запустить миграцию
psql -d your_db -f migrations/007_update_withdrawals_table.sql
```

### 2. Переменные окружения
```env
GAME_WALLET_MNEMONIC=your_wallet_mnemonic
GAME_WALLET_ADDRESS=your_wallet_address
TON_API_KEY=your_tonapi_key
```

### 3. Настройка автообработки
В `src/lib/config/withdrawals.ts` можно изменить:
- Лимиты и комиссии
- Пороги автообработки
- Временные ограничения

### 4. Запуск автообработки
```bash
# Ручной запуск очереди
curl -X POST /api/withdrawals/auto-process

# Можно настроить cron job для регулярной обработки
```

## Workflow выплат

1. **Создание заявки**
   - Пользователь указывает сумму
   - Система рассчитывает комиссию
   - Проверяются лимиты и баланс
   - Создается заявка со статусом pending/manual_review

2. **Автообработка** (для сумм ≤ 10 TON)
   - Заявка автоматически обрабатывается
   - Отправляется TON транзакция
   - Статус обновляется на completed/failed

3. **Ручная проверка** (для сумм ≥ 50 TON)
   - Админ просматривает заявку
   - Одобряет или отклоняет
   - Добавляет заметки

4. **Возврат средств**
   - При отклонении/ошибке средства возвращаются
   - Пользователь получает уведомление

## Безопасность

- Проверка возраста аккаунта (24 часа)
- Дневные лимиты на пользователя
- Двухэтапная обработка (резервирование → выполнение)
- Логирование всех операций
- Административные заметки

## Мониторинг

### Основные метрики
- Количество заявок по статусам
- Объемы выплат
- Время обработки
- Процент автообработки

### Алерты
- Большие суммы на ручной проверке
- Ошибки автообработки
- Превышение дневных лимитов

## API Примеры

### Создание заявки
```javascript
const response = await fetch('/api/withdrawals/create', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    user_id: 123,
    amount: 5.0,
    wallet_address: 'UQBx...xyz'
  })
});
```

### Админ одобрение
```javascript
const response = await fetch('/api/admin/withdrawals', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    action: 'approve',
    withdrawal_id: 456,
    admin_id: 789,
    admin_notes: 'Проверен и одобрен'
  })
});
```

## Расширения

Система готова к расширению:
- Интеграция с другими блокчейнами
- Более сложные алгоритмы комиссий
- KYC проверки
- Уведомления в Telegram
- Аналитика и отчеты