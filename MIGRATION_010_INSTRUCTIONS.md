# Применение миграции 010: Механика выигрыша

## Что изменилось

**Проблема:** Раньше если игрок бросал мяч и уходил до падения, баланс откатывался к исходному состоянию.

**Решение:** Теперь ставка списывается СРАЗУ при броске мяча, а выигрыш начисляется после падения.

## Новая архитектура

### 1. API endpoints

- **POST /api/bets/place** - создает ставку и списывает деньги (вызывается при броске)
- **POST /api/bets/complete** - завершает ставку и начисляет выигрыш (вызывается при падении)

### 2. Изменения в БД

Таблица `game_bets` получает новые поля:
- `status` VARCHAR(20) - статус ставки ('pending' или 'completed')
- `updated_at` TIMESTAMP - время обновления

### 3. Изменения в коде

**PlinkoEngine.ts:**
- `dropBall()` - теперь вызывает `/api/bets/place` и получает `bet_id`
- `handleBallEnterBin()` - вызывает `/api/bets/complete` с `bet_id`

## Как применить миграцию

### Локально (для разработки)

```bash
# Убедитесь что DATABASE_URL настроен в .env
node apply-migration-010.js
```

### На Render (продакшен)

1. Зайдите в Dashboard → Your Service → Shell

2. Выполните:
```bash
node apply-migration-010.js
```

Или альтернативно через psql:

```bash
# Подключитесь к БД
psql $DATABASE_URL

# Выполните SQL
\i migrations/010_add_game_bets_status.sql

# Проверьте
\d game_bets
```

## Проверка

После применения миграции проверьте:

1. **Таблица обновлена:**
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'game_bets' 
AND column_name IN ('status', 'updated_at');
```

Должны появиться 2 строки.

2. **Игра работает:**
- Бросьте мяч - баланс должен СРАЗУ уменьшиться
- Закройте игру или перезагрузите страницу
- Откройте снова - баланс должен остаться уменьшенным
- Дождитесь падения мяча (в другой сессии или позже) - выигрыш начислится

## Откат (если что-то пошло не так)

```sql
ALTER TABLE game_bets DROP COLUMN IF EXISTS status;
ALTER TABLE game_bets DROP COLUMN IF EXISTS updated_at;
DROP INDEX IF EXISTS idx_game_bets_status;
```

## Технические детали

### Workflow до изменений:
1. Бросок мяча → локальное списание баланса
2. Падение мяча → API запрос → списание + начисление
3. Проблема: если пользователь ушёл до шага 2, баланс откатывается

### Workflow после изменений:
1. Бросок мяча → API `/api/bets/place` → списание баланса в БД → получение bet_id
2. Падение мяча → API `/api/bets/complete` → начисление выигрыша в БД
3. Решение: баланс всегда корректный, т.к. списание сразу в БД
