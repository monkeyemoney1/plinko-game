# 💸 Автоматический вывод средств

## ✨ Что изменилось

### 🚀 Мгновенный вывод
Теперь при создании заявки на вывод средства **автоматически отправляются** через блокчейн TON!

**Было:**
1. Пользователь создаёт заявку → Статус: "В ожидании"
2. Админ одобряет → Статус: "В обработке"
3. Система отправляет TON → Статус: "Завершено"

**Стало:**
1. Пользователь создаёт заявку → **Мгновенно отправляем TON** → Статус: "Завершено" ✅

### 💰 Фиксированная комиссия 0.05 TON

**Было:**
- Фиксированная: 0.01 TON
- Процентная: 2%
- Итоговая = max(0.01, сумма × 2%)

**Стало:**
- **Фиксированная: 0.05 TON**
- Процентная: отключена
- **Итоговая = всегда 0.05 TON**

Примеры:
- Вывод 1 TON → Комиссия 0.05 TON → Получите 0.95 TON
- Вывод 10 TON → Комиссия 0.05 TON → Получите 9.95 TON
- Вывод 100 TON → Комиссия 0.05 TON → Получите 99.95 TON

## 🔄 Как работает автоматический вывод

### 1. Создание заявки
```typescript
POST /api/withdrawals/create
{
  "user_id": 123,
  "amount": 10,
  "wallet_address": "UQB..."
}
```

### 2. Проверки системы
- ✅ Баланс пользователя (сумма + 0.05 комиссия)
- ✅ Дневные лимиты
- ✅ Возраст аккаунта
- ✅ Валидность адреса кошелька

### 3. Резервирование средств
Средства сразу списываются с баланса пользователя

### 4. Отправка в блокчейн TON
```
[Withdrawal 123] Starting automatic TON transfer...
[TON Transfer] Wallet balance: 500 TON
[TON Transfer] Current seqno: 42
[TON Transfer] Transaction sent, waiting for confirmation...
[TON Transfer] Transaction confirmed! New seqno: 43
[Withdrawal 123] Successfully completed! TX: a1b2c3d4...
```

### 5. Обновление статуса
- ✅ Успех → Статус: "completed", сохраняем TX hash
- ❌ Ошибка → Статус: "failed", возвращаем средства

## 📊 Новый флоу вывода

```
Пользователь нажимает "Вывести"
         ↓
Проверка баланса и лимитов
         ↓
   Баланс - (сумма + 0.05)
         ↓
Создание записи в БД (status: pending)
         ↓
Статус → processing
         ↓
    Отправка TON через блокчейн
         ↓
    ┌─────────┴─────────┐
    ↓                   ↓
  Успех              Ошибка
    ↓                   ↓
completed           failed
TX hash          Возврат средств
```

## ⚙️ Конфигурация

### Файл: `src/lib/config/withdrawals.ts`

```typescript
export const WITHDRAWAL_CONFIG = {
  // Комиссии
  FIXED_FEE: 0.05,        // ← Фиксированная комиссия
  PERCENTAGE_FEE: 0,      // ← Отключена
  
  // Автообработка
  AUTO_PROCESS_ENABLED: true,
  AUTO_PROCESS_THRESHOLD: 999999,  // ← Все выводы автоматически
  MANUAL_REVIEW_THRESHOLD: 999999, // ← Ручная проверка отключена
};
```

### Переменные окружения

```env
# TON Wallet Configuration
GAME_WALLET_MNEMONIC="24 слова мнемоники"
GAME_WALLET_ADDRESS=UQBUqJjVTapj2_4J_CMte8FWrJ2hy4WRBIJLBymMuATA2jCX
TON_NETWORK=testnet  # или mainnet
TON_API_KEY=your_api_key
```

## 🔐 Безопасность

### Проверки перед выводом
1. **Баланс** - достаточно средств (сумма + 0.05)
2. **Возраст аккаунта** - минимум 24 часа
3. **Дневные лимиты**:
   - Максимум 500 TON в день
   - Максимум 10 выводов в день
4. **Валидация адреса** - корректный TON адрес

### Защита от потери средств
- Средства списываются ПОСЛЕ успешной отправки
- При ошибке транзакции - **автоматический возврат на баланс**
- Все операции логируются
- Transaction hash сохраняется для отслеживания

## 📝 API Ответы

### Успешный вывод
```json
{
  "success": true,
  "withdrawal": {
    "id": 123,
    "user_id": 456,
    "gross_amount": 10,
    "net_amount": 9.95,
    "fee": 0.05,
    "wallet_address": "UQB...",
    "status": "completed",
    "transaction_hash": "a1b2c3d4e5f6..."
  },
  "message": "Средства успешно отправлены! Сумма: 9.95 TON"
}
```

### Ошибка отправки
```json
{
  "success": false,
  "error": "Ошибка отправки средств: Insufficient balance. Средства возвращены на баланс."
}
```

## 🎨 UI Изменения

### Калькулятор комиссии в профиле

```
┌─────────────────────────────────────┐
│  Вывести средства                   │
├─────────────────────────────────────┤
│  Сумма: [10] TON                    │
│                                     │
│  Комиссия: 0.05 TON                 │
│  Вы получите: 9.95 TON              │
│                                     │
│  [Вывести средства] ────────────────┤
└─────────────────────────────────────┘
```

После нажатия кнопки:
```
┌─────────────────────────────────────┐
│  ⏳ Отправка средств...              │
│  Пожалуйста, подождите...           │
└─────────────────────────────────────┘
        ↓ (2-5 секунд)
┌─────────────────────────────────────┐
│  ✅ Успешно отправлено!              │
│  Сумма: 9.95 TON                    │
│  TX: a1b2c3d4...                    │
└─────────────────────────────────────┘
```

## 🔧 Технические детали

### Библиотека TON Transfer
**Файл:** `src/lib/server/ton-transfer.ts`

```typescript
export async function sendTonTransfer(
  recipientAddress: string,
  amount: number
): Promise<{ 
  success: boolean; 
  txHash?: string; 
  error?: string 
}>
```

**Функционал:**
- Подключение к TON сети (testnet/mainnet)
- Создание кошелька из мнемоники
- Проверка баланса
- Отправка транзакции
- Ожидание подтверждения (до 30 секунд)
- Получение TX hash

### Обработка ошибок

```typescript
try {
  // Отправка TON
  const result = await sendTonTransfer(address, amount);
  
  if (result.success) {
    // Обновить статус: completed
    // Сохранить TX hash
  } else {
    // Обновить статус: failed
    // Вернуть средства на баланс
  }
} catch (error) {
  // Откатить транзакцию
  // Вернуть средства
  // Логировать ошибку
}
```

## 📈 Мониторинг

### Логи выводов
```bash
[Withdrawal 123] Starting automatic TON transfer...
[TON Transfer] Wallet balance: 500 TON
[TON Transfer] Transaction sent
[TON Transfer] Transaction confirmed!
[Withdrawal 123] Successfully completed! TX: abc123
```

### Статусы в БД
- `pending` - создана заявка (1-2 секунды)
- `processing` - отправляем TON (2-5 секунд)
- `completed` - успешно ✅
- `failed` - ошибка, средства возвращены ❌

## 🚀 Deployment

### При деплое на Render

Автоматически:
1. Миграция БД (создание таблицы withdrawals)
2. Загрузка переменных окружения
3. Проверка GAME_WALLET_MNEMONIC
4. Запуск приложения

### Проверка работы

1. **Тестовый вывод 0.1 TON**
   ```bash
   curl -X POST https://your-app.com/api/withdrawals/create \
     -H "Content-Type: application/json" \
     -d '{
       "user_id": 1,
       "amount": 0.1,
       "wallet_address": "UQB..."
     }'
   ```

2. **Проверка TX в блокчейне**
   - Testnet: https://testnet.tonscan.org/tx/{txHash}
   - Mainnet: https://tonscan.org/tx/{txHash}

## ⚠️ Важно

### Безопасность мнемоники
- ❌ **НЕ коммитьте** GAME_WALLET_MNEMONIC в git
- ✅ Храните только в переменных Render
- ✅ Используйте разные кошельки для testnet/mainnet

### Баланс кошелька игры
- Следите за балансом GAME_WALLET_ADDRESS
- При балансе < 100 TON пополните кошелёк
- Автоматические выводы остановятся если недостаточно средств

### Лимиты
Текущие настройки:
- Минимум: 0.1 TON
- Максимум: 100 TON за раз
- Максимум: 500 TON в день
- Максимум: 10 выводов в день

## 🎉 Преимущества

✅ **Мгновенно** - вывод за 2-5 секунд  
✅ **Автоматически** - без участия админа  
✅ **Безопасно** - возврат при ошибках  
✅ **Прозрачно** - TX hash для проверки  
✅ **Дешево** - фиксированная комиссия 0.05 TON  

---

Теперь ваши пользователи получают средства мгновенно! 🚀
