/**
 * –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π SQL –∑–∞–ø—Ä–æ—Å
 */

import { db } from './src/lib/db.js';

async function createTable() {
  console.log('üóÑÔ∏è –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É user_wallets...');
  
  try {
    const createTableSQL = `
      CREATE TABLE IF NOT EXISTS user_wallets (
          id SERIAL PRIMARY KEY,
          user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
          wallet_address VARCHAR(200) NOT NULL,
          is_connected BOOLEAN DEFAULT true,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
    `;
    
    await db.query(createTableSQL);
    console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_wallets —Å–æ–∑–¥–∞–Ω–∞!');
    
    // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
    const indexQueries = [
      'CREATE INDEX IF NOT EXISTS idx_user_wallets_user_id ON user_wallets(user_id);',
      'CREATE INDEX IF NOT EXISTS idx_user_wallets_address ON user_wallets(wallet_address);',
      'CREATE INDEX IF NOT EXISTS idx_user_wallets_created_at ON user_wallets(created_at);',
      'CREATE UNIQUE INDEX IF NOT EXISTS idx_user_wallets_unique ON user_wallets(user_id, wallet_address);'
    ];
    
    for (const indexSQL of indexQueries) {
      await db.query(indexSQL);
    }
    
    console.log('‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã!');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É
    const result = await db.query("SELECT COUNT(*) as count FROM user_wallets");
    console.log(`üìã –¢–∞–±–ª–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞, –∑–∞–ø–∏—Å–µ–π: ${result.rows[0].count}`);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
  } finally {
    process.exit(0);
  }
}

createTable();