<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Telegram Stars - Plinko Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: #fff;
        }
        button {
            background: #4CAF50;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .result {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .error {
            background: #d32f2f;
        }
        .success {
            background: #388e3c;
        }
    </style>
</head>
<body>
    <h1>üåü –¢–µ—Å—Ç Telegram Stars Integration</h1>
    
    <div class="container">
        <h2>üì± Telegram WebApp Info</h2>
        <div id="telegram-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="container">
        <h2>üí∞ –°–æ–∑–¥–∞–Ω–∏–µ Stars Invoice</h2>
        <input type="number" id="stars-amount" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Stars" value="10" min="1">
        <input type="text" id="stars-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞" value="–¢–µ—Å—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞">
        <br>
        <button onclick="createStarsInvoice()">–°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å</button>
        <div id="invoice-result" class="result" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞</h2>
        <input type="text" id="payload-input" placeholder="Payload –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏">
        <br>
        <button onclick="verifyPayment()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
        <div id="verify-result" class="result" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>üîó –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        <button onclick="testFullFlow()">–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç (—Å–æ–∑–¥–∞—Ç—å + –æ–ø–ª–∞—Ç–∏—Ç—å)</button>
        <button onclick="checkBalance()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å Stars</button>
        <div id="action-result" class="result" style="display: none;"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tgUser = null;
        
        function initTelegram() {
            const info = document.getElementById('telegram-info');
            
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                
                tgUser = tg.initDataUnsafe?.user;
                
                info.innerHTML = `
                    <strong>Platform:</strong> ${tg.platform}<br>
                    <strong>Version:</strong> ${tg.version}<br>
                    <strong>User ID:</strong> ${tgUser?.id || '–ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω'}<br>
                    <strong>Username:</strong> ${tgUser?.username || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                    <strong>First Name:</strong> ${tgUser?.first_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                    <strong>Is Premium:</strong> ${tgUser?.is_premium ? '–î–∞' : '–ù–µ—Ç'}<br>
                    <strong>Init Data:</strong> ${tg.initData ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
                `;
            } else {
                info.innerHTML = `
                    <span style="color: #ff6b6b;">‚ö†Ô∏è Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span><br>
                    –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞.
                `;
            }
        }

        async function createStarsInvoice() {
            const amount = document.getElementById('stars-amount').value;
            const description = document.getElementById('stars-description').value;
            const resultDiv = document.getElementById('invoice-result');
            
            if (!amount || amount < 1) {
                showResult(resultDiv, '–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ Stars', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/payments/stars/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: tgUser?.id || 12345678, // –¢–µ—Å—Ç–æ–≤—ã–π ID –µ—Å–ª–∏ Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                        amount: parseInt(amount),
                        description: description
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult(resultDiv, 
                        `‚úÖ –ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!\n\n` +
                        `üí∞ –°—É–º–º–∞: ${data.amount} Stars\n` +
                        `üîó –°—Å—ã–ª–∫–∞: ${data.invoice_link}\n` +
                        `üìã Payload: ${data.payload}\n\n` +
                        `–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã:`,
                        'success'
                    );
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                    const linkButton = document.createElement('button');
                    linkButton.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∏–Ω–≤–æ–π—Å';
                    linkButton.onclick = () => {
                        if (window.Telegram?.WebApp?.openInvoice) {
                            window.Telegram.WebApp.openInvoice(data.invoice_link, (status) => {
                                showResult(resultDiv, `–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞: ${status}`, 
                                    status === 'paid' ? 'success' : 'error');
                                
                                if (status === 'paid') {
                                    document.getElementById('payload-input').value = data.payload;
                                }
                            });
                        } else {
                            window.open(data.invoice_link, '_blank');
                        }
                    };
                    
                    resultDiv.appendChild(document.createElement('br'));
                    resultDiv.appendChild(linkButton);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º payload –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    document.getElementById('payload-input').value = data.payload;
                    
                } else {
                    showResult(resultDiv, `‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }

        async function verifyPayment() {
            const payload = document.getElementById('payload-input').value;
            const resultDiv = document.getElementById('verify-result');
            
            if (!payload) {
                showResult(resultDiv, '–í–≤–µ–¥–∏—Ç–µ payload –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/payments/stars/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ payload })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.success) {
                        showResult(resultDiv, 
                            `‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!\n\n` +
                            `üí∞ –°—É–º–º–∞: ${data.amount} Stars\n` +
                            `üë§ User ID: ${data.user_id}\n` +
                            `üìÖ –î–∞—Ç–∞: ${new Date(data.created_at).toLocaleString()}\n` +
                            `üÜî Transaction ID: ${data.transaction_id}`,
                            'success'
                        );
                    } else {
                        showResult(resultDiv, '‚ùå –ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', 'error');
                    }
                } else {
                    showResult(resultDiv, `‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            const resultDiv = document.getElementById('action-result');
            showResult(resultDiv, 'üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞...', 'success');
            
            // –°–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å
            await new Promise(resolve => setTimeout(resolve, 1000));
            await createStarsInvoice();
            
            showResult(resultDiv, 
                '‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n' +
                '1. –ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω ‚úì\n' +
                '2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—à–µ\n' +
                '3. –û–ø–ª–∞—Ç–∏—Ç–µ –∏–Ω–≤–æ–π—Å\n' +
                '4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂" –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏',
                'success'
            );
        }

        async function checkBalance() {
            const resultDiv = document.getElementById('action-result');
            const userId = tgUser?.id || 12345678;
            
            try {
                const response = await fetch(`/api/users/${userId}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(resultDiv, 
                        `üí∞ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:\n\n` +
                        `‚≠êÔ∏è Stars: ${data.user?.stars_balance || 0}\n` +
                        `üíé TON: ${data.user?.ton_balance || 0}\n` +
                        `üéÆ Game Balance: ${data.user?.balance || 0}`,
                        'success'
                    );
                } else {
                    showResult(resultDiv, `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }

        function showResult(element, text, type = '') {
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = text;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initTelegram);
    </script>
</body>
</html>